services:
  postgres:
    image: postgres:16-alpine
    container_name: chatwarp-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: chatwarp
      POSTGRES_PASSWORD: chatwarp
      POSTGRES_DB: chatwarp
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U chatwarp"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - chatwarp-net

  chatwarp-api:
    build:
      context: .
      dockerfile: Dockerfile
    image: chatwarp-api:local
    container_name: chatwarp-api
    restart: unless-stopped
    environment:
      SERVER_PORT: 8080
      DATABASE_URL: postgres://chatwarp:chatwarp@postgres:5432/chatwarp
      WA_WS_URL: wss://web.whatsapp.com/ws/chat
      INSTANCE_CONNECT_WAIT_MS: 300 
      RUST_LOG: debug 
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/healthz || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - chatwarp-net

  newman:
    image: postman/newman:6-alpine
    container_name: chatwarp-newman
    profiles:
      - tools
    depends_on:
      chatwarp-api:
        condition: service_healthy
    volumes:
      - ./postman:/etc/newman
    command:
      - run
      - /etc/newman/collections/chatwarp-api.docker.postman_collection.json
      - -e
      - /etc/newman/environments/chatwarp-api.docker.postman_environment.json
    networks:
      - chatwarp-net

volumes:
  postgres-data:

networks:
  chatwarp-net:
    name: chatwarp-net
